#!/usr/bin/env php
<?php
/**
 * TRAI SMS Header CLI Inspector
 *
 * Usage:
 *   vendor/bin/trai-sms-header <HEADER> [--file=/path/to/sender-list.json] [--json]
 *   vendor/bin/trai-sms-header build-json <input.xlsx|input.csv> [--output=/path/to/sender-list.json]
 *
 * Examples:
 *   vendor/bin/trai-sms-header VM-ABCDEF-S
 *   vendor/bin/trai-sms-header VM-ABCDEF-S --file=/tmp/custom-senders.json
 *   vendor/bin/trai-sms-header VM-ABCDEF-S --json
 */

require __DIR__ . '/../vendor/autoload.php';

use Cyberwani\TRAI_SMS_Header\TRAI_SMS_Header;

// Detect if user wants to run the build-json command
$args = $argv;
array_shift($args); // remove script name

if (empty($args)) {
    echo "Usage:\n";
    echo "  trai-sms-header <HEADER> [--file=/path/to/sender-list.json] [--json]\n";
    echo "  trai-sms-header build-json <input.xlsx|input.csv> [--output=/path/to/sender-list.json]\n";
    exit(1);
}

// Handle subcommands
$command = $args[0];

if ($command === 'build-json') {
    // ---------------------------------------------
    // SUBCOMMAND: build-json (convert Excel/CSV â†’ JSON)
    // ---------------------------------------------
    if (empty($args[1])) {
        echo "âŒ Please provide the path to TRAI sender list file (.xlsx or .csv)\n";
        exit(1);
    }

    $inputFile = $args[1];
    $outputFile = 'src/Data/sender-list.json'; // default
    foreach ($args as $arg) {
        if (strpos($arg, '--output=') === 0) {
            $outputFile = substr($arg, 9);
        }
    }

    // Detect file type
    $ext = strtolower(pathinfo($inputFile, PATHINFO_EXTENSION));
    $data = [];

    if (!file_exists($inputFile)) {
        echo "âŒ File not found: $inputFile\n";
        exit(1);
    }

    echo "ğŸ”„ Reading $inputFile ...\n";

    if ($ext === 'xlsx') {
        // Use PhpSpreadsheet
        $reader = \PhpOffice\PhpSpreadsheet\IOFactory::createReader('Xlsx');
        $spreadsheet = $reader->load($inputFile);
        $sheet = $spreadsheet->getActiveSheet();
        $highestRow = $sheet->getHighestRow();

        for ($row = 2; $row <= $highestRow; $row++) {
            $senderId = strtoupper(trim((string)$sheet->getCellByColumnAndRow(1, $row)->getValue()));
            $senderName = trim((string)$sheet->getCellByColumnAndRow(2, $row)->getValue());
            if ($senderId !== '') {
                $data[$senderId] = $senderName;
            }
        }
    } elseif ($ext === 'csv') {
        if (($handle = fopen($inputFile, 'r')) !== false) {
            fgetcsv($handle); // skip header
            while (($row = fgetcsv($handle)) !== false) {
                $senderId = strtoupper(trim($row[0] ?? ''));
                $senderName = trim($row[1] ?? '');
                if ($senderId !== '') {
                    $data[$senderId] = $senderName;
                }
            }
            fclose($handle);
        }
    } else {
        echo "âŒ Unsupported file format. Please use .xlsx or .csv\n";
        exit(1);
    }

    if (empty($data)) {
        echo "âš ï¸ No sender records found in the input file.\n";
        exit(1);
    }

    file_put_contents($outputFile, json_encode($data, JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE));

    echo "âœ… Exported " . count($data) . " sender records to $outputFile\n";
    exit(0);
}

// ---------------------------------------------
// DEFAULT COMMAND: inspect header
// ---------------------------------------------
$header = null;
$jsonOutput = false;
$customFile = null;

foreach ($args as $arg) {
    if (strpos($arg, '--file=') === 0) {
        $customFile = substr($arg, 7);
    } elseif ($arg === '--json') {
        $jsonOutput = true;
    } elseif (!$header && $arg !== 'build-json') {
        $header = $arg;
    }
}

if (!$header) {
    echo "âŒ Error: Header not provided.\n";
    echo "Usage: trai-sms-header <HEADER>\n";
    exit(1);
}

// --------------------
// Initialize library
// --------------------
$trai = new TRAI_SMS_Header($customFile);
$result = $trai->inspect($header);

// --------------------
// Output result
// --------------------
if ($jsonOutput) {
    echo json_encode($result, JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE) . "\n";
    exit(0);
}

// Human-readable output
echo "ğŸ” TRAI SMS Header Inspection\n";
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n";

if (isset($result['error'])) {
    echo "âŒ Error: {$result['error']}\n";
    exit(1);
}

echo "Header:       {$header}\n";
echo "Prefix:       {$result['prefix']}\n";
echo "Operator:     {$result['operator']} ({$result['operator_code']})\n";
echo "Circle:       {$result['circle']} ({$result['circle_code']})\n";
echo "Sender ID:    {$result['sender_id']}\n";
echo "Sender Name:  {$result['sender_name']}\n";
echo "Message Type: {$result['message_type']}\n";
echo "Suffix:       " . ($result['suffix'] ?? 'None') . "\n";
echo "Valid:        " . ($result['valid'] ? 'Yes' : 'No') . "\n";
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n";
